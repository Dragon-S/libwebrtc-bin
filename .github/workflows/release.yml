name: Create Release

on:
  push:
    branches-ignore:
      - '**'
    tags:
      - 'v*.*.*'

jobs:
  release_linux:
    name: Release for arm
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v1
      -
        name: Output Disk size
        run: df -hT
      -
        name: Build for arm
        run: make arm
        working-directory: build
        timeout-minutes: 120
      -
        name: Output Disk size
        run: df -hT
      -
        name: Release for arm
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "package/libwebrtc-linux-arm.tar.xz"
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_PERSONAL_TOKEN }}
      -
        name: Build for arm64
        run: make arm64
        working-directory: build
        timeout-minutes: 120
      -
        name: Output Disk size
        run: df -hT
      -
        name: Release for arm64
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "package/libwebrtc-linux-arm64.tar.xz"
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_PERSONAL_TOKEN }}
      -
        name: Build for x64
        run: make x64
        working-directory: build
        timeout-minutes: 120
      -
        name: Output Disk size
        run: df -hT
      -
        name: Release for x64
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "package/libwebrtc-linux-x64.tar.xz"
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_PERSONAL_TOKEN }}
  release_macos:
    name: Release for macOS
    runs-on: macos-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v1
      -
        name: Output Disk size
        run: df -h
      -
        name: Build for macOS
        run: make macos
        working-directory: build
        timeout-minutes: 120
      -
        name: Output Disk size
        run: df -h
      -
        name: Release for macOS
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "package/libwebrtc-macos-x64.tar.xz"
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_PERSONAL_TOKEN }}
  release_win:
    name: Release for Windows
    runs-on: windows-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v1
      -
        name: Disk Cleanup
        run: .\disk_cleanup.bat
      -
        name: Build for Windows
        run: .\build.bat
        timeout-minutes: 120
      -
        name: Prepare for Release
        run: .\release.bat
      -
        name: Release for Windows
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "package/libwebrtc-win-x64.tar.xz"
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_PERSONAL_TOKEN }}

